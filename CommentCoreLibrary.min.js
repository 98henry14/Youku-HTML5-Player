/*!
 *
 * Comment Core Library CommentManager
 * @license MIT
 * @author Jim Chen
 *
 * Copyright (c) 2014 Jim Chen
 *
 * XMLParsr
 * == Licensed Under the MIT License : /LICENSING
 * Copyright (c) 2012 Jim Chen ( CQZ, Jabbany )
 */
/** 
 * Comment Filters Module Simplified (only supports modifiers & types)
 * @license MIT
 * @author Jim Chen
 */
function CommentFilter(){this.modifiers=[],this.runtime=null,this.allowTypes={1:!0,4:!0,5:!0,6:!0,7:!0,8:!0,17:!0},this.doModify=function(t){for(var e=0;e<this.modifiers.length;e++)t=this.modifiers[e](t);return t},this.beforeSend=function(t){return t},this.doValidate=function(t){return this.allowTypes[t.mode]?!0:!1},this.addRule=function(){},this.addModifier=function(t){this.modifiers.push(t)},this.runtimeFilter=function(t){return null==this.runtime?t:this.runtime(t)},this.setRuntimeFilter=function(t){this.runtime=t}}/** 
 * Bilibili Format Parser
 * @license MIT License
 * Takes in an XMLDoc/LooseXMLDoc and parses that into a Generic Comment List
 **/
function BilibiliParser(t,e,i){function n(t){return t.replace(/\t/,"\\t")}function s(t){if("["==t.charAt(0))switch(t.charAt(t.length-1)){case"]":return t;case'"':return t+"]";case",":return t.substring(0,t.length-1)+'"]';default:return s(t.substring(0,t.length-1))}return"["!==t.charAt(0)?t:void 0}if(null!==t)var o=t.getElementsByTagName("d");else{if(!document||!document.createElement)return[];if(i){if(!confirm("XML Parse Error. \n Allow tag soup parsing?\n[WARNING: This is unsafe.]"))return[]}else e=e.replace(new RegExp("</([^d])","g"),"</disabled $1"),e=e.replace(new RegExp("</(S{2,})","g"),"</disabled $1"),e=e.replace(new RegExp("<([^d/]W*?)","g"),"<disabled $1"),e=e.replace(new RegExp("<([^/ ]{2,}W*?)","g"),"<disabled $1");var r=document.createElement("div");r.innerHTML=e;var o=r.getElementsByTagName("d")}for(var a=[],h=0;h<o.length;h++)if(null!=o[h].getAttribute("p")){var l=o[h].getAttribute("p").split(",");if(!o[h].childNodes[0])continue;var e=o[h].childNodes[0].nodeValue,c={};if(c.stime=Math.round(1e3*parseFloat(l[0])),c.size=parseInt(l[2]),c.color=parseInt(l[3]),c.mode=parseInt(l[1]),c.date=parseInt(l[4]),c.pool=parseInt(l[5]),c.position="absolute",null!=l[7]&&(c.dbid=parseInt(l[7])),c.hash=l[6],c.border=!1,c.mode<7)c.text=e.replace(/(\/n|\\n|\n|\r\n)/g,"\n");else if(7==c.mode)try{if(adv=JSON.parse(n(s(e))),c.shadow=!0,c.x=parseFloat(adv[0]),c.y=parseFloat(adv[1]),(Math.floor(c.x)<c.x||Math.floor(c.y)<c.y)&&(c.position="relative"),c.text=adv[4].replace(/(\/n|\\n|\n|\r\n)/g,"\n"),c.rZ=0,c.rY=0,adv.length>=7&&(c.rZ=parseInt(adv[5],10),c.rY=parseInt(adv[6],10)),c.motion=[],c.movable=!1,adv.length>=11){c.movable=!0;var d=500,p={x:{from:c.x,to:parseFloat(adv[7]),dur:d,delay:0},y:{from:c.y,to:parseFloat(adv[8]),dur:d,delay:0}};if(""!==adv[9]&&(d=parseInt(adv[9],10),p.x.dur=d,p.y.dur=d),""!==adv[10]&&(p.x.delay=parseInt(adv[10],10),p.y.delay=parseInt(adv[10],10)),adv.length>11&&(c.shadow=adv[11],"true"===c.shadow&&(c.shadow=!0),"false"===c.shadow&&(c.shadow=!1),null!=adv[12]&&(c.font=adv[12]),adv.length>14)){"relative"===c.position&&(console.log("Cannot mix relative and absolute positioning"),c.position="absolute");for(var f=adv[14],u={x:p.x.from,y:p.y.from},m=[],g=new RegExp("([a-zA-Z])\\s*(\\d+)[, ](\\d+)","g"),y=f.split(/[a-zA-Z]/).length-1,_=g.exec(f);null!==_;){switch(_[1]){case"M":u.x=parseInt(_[2],10),u.y=parseInt(_[3],10);break;case"L":m.push({x:{from:u.x,to:parseInt(_[2],10),dur:d/y,delay:0},y:{from:u.y,to:parseInt(_[3],10),dur:d/y,delay:0}}),u.x=parseInt(_[2],10),u.y=parseInt(_[3],10)}_=g.exec(f)}p=null,c.motion=m}null!==p&&c.motion.push(p)}c.dur=2500,adv[3]<12&&(c.dur=1e3*adv[3]);var r=adv[2].split("-");if(null!=r&&r.length>1){var v=parseFloat(r[0]),x=parseFloat(r[1]);c.opacity=v,v!==x&&(c.alpha={from:v,to:x})}}catch(t){console.log("[Err] Error occurred in JSON parsing"),console.log("[Dbg] "+e)}else 8==c.mode&&(c.code=e);null!=c.text&&(c.text=c.text.replace(/\u25a0/g,"█")),a.push(c)}return a}window.getjson=function(t,e){var i;i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),i.onreadystatechange=function(){4==i.readyState&&e(200==i.status&&"{"==i.response.substr(0,1)&&"}"==i.response.substr(-1,1)?JSON.parse(i.response):{code:-502,message:"网络错误"})},i.open("GET",t,!0),i.withCredentials=!0,i.send()};var CCLScripting=function(t){this.version=1,this.workerUrl=t,this.logger=new function(){this.log=function(t){console.log(t)},this.error=function(t){console.error(t)},this.warn=function(t){console.warn(t)}},this.getWorker=function(){return new Worker(this.workerUrl)},this.getScriptingContext=function(t){return new this.ScriptingContext(this,t)},this.getSandbox=function(t,e){return new this.BridgedSandbox(this,t,e)}};!function(){if(!CCLScripting)throw new Error("CCL: Scripting engine not defined.");CCLScripting.prototype.ScriptingContext=function(t,e){var i={};this.registerObject=function(n,s){return"function"!=typeof this.Unpack[s.class]?void t.logger.error('Cannot unpack class "'+s.class+'". No valid unpacker found'):void(i[n]=new this.Unpack[s.class](e,s,this))},this.deregisterObject=function(t){delete i[t]},this.updateProperty=function(e,n,s){return i[e]?void 0===i[e][n]?void t.logger.error('Property "'+n+'" not defined for object of type '+i[e].getClass()+"."):void(i[e][n]=s):void t.logger.error("Object ("+e+") not found.")},this.callMethod=function(e,n,s){if(!i[e])return void t.logger.error("Object ("+e+") not found.");if(!i[e][n])return void t.logger.error('Method "'+n+'" not defined for object of type '+i[e].getClass()+".");try{i[e][n](s)}catch(e){t.logger.error(e.stack?e.stack:e.toString())}},this.getObject=function(e){return i.hasOwnProperty(e)?i[e]:(t.logger.error("Object ("+e+") not found."),i[e])},this.invokeError=function(e,i){switch(i){case"err":t.logger.error(e);break;case"warn":t.logger.warn(e);break;default:case"log":t.logger.log(e)}},this.clear=function(){},this.getDimensions=function(){return{stageWidth:e.offsetWidth,stageHeight:e.offsetHeight,screenWidth:window.screen.width,screenHeight:window.screen.height}}},CCLScripting.prototype.ScriptingContext.prototype.Unpack={},CCLScripting.prototype.BridgedSandbox=function(t,e,i){var n=t.getWorker(),s=t.getScriptingContext(e),o=i,r={},a=!1,h=this;if(!n)throw new Error("SANDBOX: Worker pool exhausted.");this.getLogger=function(){return t.logger},this.getPlayer=function(){return o},this.getContext=function(){return s},this.addListener=function(t,e){return r[t]||(r[t]={max:0,listeners:[]}),r[t].max>0&&r[t].listeners.length>=r[t].max?!1:(r[t].listeners.push(e),!0)};var l=function(e){if(r[e.channel]&&r[e.channel].listeners)for(var i=0;i<r[e.channel].listeners.length;i++)r[e.channel].listeners[i](e.payload);else t.logger.warn('Message for channel "'+e.channel+'" but channel not existant.')},c=function(e){try{var i=JSON.parse(e.data)}catch(t){return void console.log(t)}if(""!==i.channel)if("::worker"===i.channel.substring(0,8)){var n=i.channel.substring(8);switch(n){case":state":"running"===i.payload&&"worker"===i.auth&&(a=!0,r={},h.init());break;default:console.log(i)}}else l(i);else switch(i.mode){case"log":default:t.logger.log(i.obj);break;case"warn":t.logger.warn(i.obj);break;case"err":t.logger.error(i.obj);break;case"fatal":return t.logger.error(i.obj),void h.resetWorker()}};this.resetWorker=function(){try{n.terminate()}catch(t){}if(n=t.getWorker(),!n)throw new Error("SANDBOX: Worker pool exhausted.");n.addEventListener("message",c)},n.addEventListener("message",c),this.eval=function(t){if(!a)throw new Error("Worker offline");n.postMessage(JSON.stringify({channel:"::eval",payload:t}))},this.send=function(t,e){n.postMessage(JSON.stringify({channel:t,payload:e}))}},CCLScripting.prototype.BridgedSandbox.prototype.init=function(){var t=this;t.send("Update:DimensionUpdate",t.getContext().getDimensions()),this.addListener("Runtime::alert",function(t){alert(t)}),this.addListener("Runtime::clear",function(){t.getContext().clear()}),this.addListener("Player::action",function(e){try{if(null==t.getPlayer())return void t.getLogger().warn("Player not initialized!");switch(e.action){default:return;case"play":t.getPlayer().play();break;case"pause":t.getPlayer().pause();break;case"seek":t.getPlayer().seek(e.params);break;case"jump":t.getPlayer().jump(e.params)}}catch(e){t.getLogger().error(e.stack?e.stack:e.toString())}}),this.addListener("Runtime:RegisterObject",function(e){t.getContext().registerObject(e.id,e.data)}),this.addListener("Runtime:DeregisterObject",function(e){t.getContext().deregisterObject(e.id)}),this.addListener("Runtime:CallMethod",function(e){t.getContext().callMethod(e.id,e.method,e.params)}),this.addListener("Runtime:UpdateProperty",function(e){t.getContext().updateProperty(e.id,e.name,e.value)}),t.getContext().registerObject("__root",{class:"SpriteRoot"})}}(),function(){var t=function(t,e,i,n){var s=null;if("text"===t)return document.createTextNode(e);s="svg"===t?document.createElementNS("http://www.w3.org/2000/svg","svg"):document.createElement(t);for(var o in e)if("style"!==o&&"className"!==o)s.setAttribute(o,e[o]);else if("className"===o)s.className=e[o];else for(var r in e.style)s.style[r]=e.style[r];if(i)for(var a=0;a<i.length;a++)null!=i[a]&&s.appendChild(i[a]);return n&&"function"==typeof n&&n(s),s},e=CCLScripting.prototype.ScriptingContext;e.prototype.Unpack.TextField=function(e,i){this.DOM=t("div",{style:{position:"absolute",opacity:null!=i.alpha?i.alpha:1,transformOrigin:"0 0 0"},className:"cmt"}),this.DOM.appendChild(document.createTextNode(i.text));var n=function(t){"string"==typeof t&&(t=parseInt(t),t===0/0&&(t=0));for(var e=t.toString(16);e.length<6;)e="0"+e;return"#"+e};this.setTextFormat=function(t){this.DOM.style.fontFamily=t.font,this.DOM.style.fontSize=t.size+"px",this.DOM.style.color=n(t.color),t.color<=16&&(this.DOM.style.textShadow="0 0 1px #fff"),t.bold&&(this.DOM.style.fontWeight="bold"),t.underline&&(this.DOM.style.textDecoration="underline"),t.italic&&(this.DOM.style.fontStyle="italic"),this.DOM.style.margin=t.margin},this.setTextFormat(i.textFormat),this.setX=function(t){i.x=t,this.DOM.style.left=i.x+"px"},this.setY=function(t){i.y=t,this.DOM.style.top=i.y+"px"},this.setAlpha=function(t){i.alpha=t,this.DOM.style.opacity=t},this.setX(i.x),this.setY(i.y),this.setText=function(e){this.DOM.innerHTML="",this.DOM.appendChild(t("text",e))},this.__defineSetter__("visible",function(t){this.DOM.style.visibility=t?"visible":"hidden"}),this.__defineGetter__("visible",function(){return"hidden"===this.DOM.style.visibility?!1:!0}),this.__defineSetter__("alpha",function(t){this.setAlpha(t)}),this.__defineGetter__("alpha",function(){return i.alpha}),this.__defineSetter__("x",function(t){this.setX(t)}),this.__defineSetter__("y",function(t){this.setY(t)}),this.__defineGetter__("x",function(){return i.x}),this.__defineGetter__("y",function(){return i.y}),this.__defineGetter__("text",function(){return this.DOM.textContent}),this.__defineSetter__("text",function(t){this.setText(t)}),this.__defineGetter__("filters",function(){return[]}),this.__defineSetter__("filters",function(t){this.setFilters([t])}),this.__defineGetter__("transform",function(){return{}}),this.__defineGetter__("transform",function(){return{}}),this.__defineSetter__("transform",function(t){if("2d"===t.mode)var e=[t.matrix[0],t.matrix[3],t.matrix[1],t.matrix[4],t.matrix[2],t.matrix[5]],i="matrix("+e.join(",")+")";else var i="matrix3d("+t.matrix.join(",")+")";this.DOM.style.transform=i}),this.setFilters=function(t){for(var e=[],i=0;i<t[0].length;i++){var s=t[0][i];if("blur"===s.type)e.push([0,0,Math.max(s.params.blurX,s.params.blurY)+"px"].join(" "));else if("glow"===s.type)for(var i=0;i<Math.min(2,s.params.strength);i++)e.push([0,0,Math.max(s.params.blurX,s.params.blurY)+"px",n(s.params.color)].join(" "))}this.DOM.style.textShadow=e.join(",")},this.unload=function(){try{e.removeChild(this.DOM)}catch(t){}},e.appendChild(this.DOM)},e.prototype.Unpack.Shape=function(e,i){this.DOM=t("svg",{width:2*e.offsetWidth,height:2*e.offsetHeight,style:{position:"absolute",top:"0px",left:"0px",width:2*e.offsetWidth+"px",height:2*e.offsetWidth+"px",transform:"matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)"}}),this._x=i.x?i.x:0,this._y=i.y?i.y:0,this._alpha=i.alpha?i.alpha:1,this._transform="";var n=function(t,e){if("string"==typeof t)var i=document.createElementNS("http://www.w3.org/2000/svg",t);else var i=t;if(e)for(var n in e)i.setAttribute(n,e[n]);return i},s=n("defs"),o=n("g",{}),r=n("g",{transform:"translate("+this._x+","+this._y+")",opacity:this._alpha});r.appendChild(o);var a=r;this.DOM.appendChild(s),this.DOM.appendChild(a),this.__defineSetter__("visible",function(t){this.DOM.style.visibility=t?"visible":"hidden"}),this.__defineGetter__("visible",function(){return"hidden"===this.DOM.style.visibility?!1:!0}),this.__defineSetter__("x",function(t){this.setX(t)}),this.__defineSetter__("y",function(t){this.setY(t)}),this.__defineSetter__("alpha",function(t){this.setAlpha(t)}),this.__defineGetter__("x",function(){return this._x}),this.__defineGetter__("y",function(){return this._y}),this.__defineGetter__("alpha",function(){return this._alpha}),this.__defineGetter__("transform",function(){return{}}),this.__defineSetter__("transform",function(t){if("2d"===t.mode){var e=[t.matrix[0],t.matrix[3],t.matrix[1],t.matrix[4],t.matrix[2],t.matrix[5]];this._transform="matrix("+e.join(",")+")"}else this._transform="matrix3d("+t.matrix.join(",")+")";"2d"===t.mode?(this.DOM.style.transform="matrix(1,0,0,1,0,0)",n(o,{transform:this._transform})):(this.DOM.style.transformOrigin=this._x+p+"px "+(this._y+f)+"px 0",this.DOM.style.transform=this._transform)}),this.line={width:0,color:"#ffffff",alpha:1},this.fill={fill:"none",alpha:1,fillRule:"nonzero"};var h=function(t){for(var e=parseInt(t).toString(16);e.length<6;)e="0"+e;return"#"+e},l=function(t,e){n(t,{stroke:e.line.color,"stroke-width":e.line.width,"stroke-opacity":e.line.alpha}),e.line.caps&&t.setAttribute("stroke-linecap",e.line.caps),e.line.joints&&t.setAttribute("stroke-linejoin",e.line.joints),e.line.miterLimit&&t.setAttribute("stroke-miterlimit",e.line.miterLimit)},c=function(t,e){n(t,{fill:e.fill.fill,"fill-opacity":e.fill.alpha,"fill-rule":e.fill.fillRule})},d={lastPath:null,scheduleClear:[]},p=0,f=0;this.offset=function(t,e){p=t,f=e,n(r,{transform:"translate("+(this._x+p)+","+(this._y+f)+")"})},this.setX=function(t){t&&(this._x=t,n(r,{transform:"translate("+(this._x+p)+","+(this._y+f)+")"}))},this.setY=function(t){t&&(this._y=t,n(r,{transform:"translate("+(this._x+p)+","+(this._y+f)+")"}))},this.setAlpha=function(t){t&&(this._alpha=t,n(r,{opacity:this._alpha}))},this.moveTo=function(t){var e=n("path",{d:"M"+t.join(" ")});c(e,this),d.lastPath=e,l(e,this),o.appendChild(d.lastPath)},this.lineTo=function(t){d.lastPath||(d.lastPath=n("path",{d:"M0 0"}),c(d.lastPath,this),l(d.lastPath,this),o.appendChild(d.lastPath)),n(d.lastPath,{d:d.lastPath.getAttribute("d")+" L"+t.join(" ")})},this.curveTo=function(t){d.lastPath||(d.lastPath=n("path",{d:"M0 0"}),c(d.lastPath,this),l(d.lastPath,this),o.appendChild(d.lastPath)),n(d.lastPath,{d:d.lastPath.getAttribute("d")+" Q"+t.join(" ")})},this.lineStyle=function(t){t.length<3||(this.line.width=t[0],this.line.color=h(t[1]),this.line.alpha=t[2],t[3]&&(this.line.caps=t[3]),t[4]&&(this.line.joints=t[4]),t[5]&&(this.line.miterLimit=t[5]),d.lastPath&&l(d.lastPath,this))},this.drawPath=function(t){var e=t[0],i=t[1];this.fill.fillRule="nonZero"===t[2]?"nonzero":"evenodd";for(var s="M0 0",r=0;r<e.length;r++)switch(e[r]){default:case 0:continue;case 1:s+=" M"+i.splice(0,2).join(" ");break;case 2:s+=" L"+i.splice(0,2).join(" ");break;case 3:s+=" Q"+i.splice(0,4).join(" ");break;case 4:i.splice(0,2),s+=" M"+i.splice(0,2).join(" ");break;case 5:i.splice(0,2),s+=" L"+i.splice(0,2).join(" ");break;case 6:s+=" C"+i.splice(0,6).join(" ")}var a=n("path",{d:s});c(a,this),l(a,this),o.appendChild(a),this._clear()},this.beginFill=function(t){0!==t.length&&(this.fill.fill=h(t[0]),t.length>1&&(this.fill.alpha=t[1]))},this.endFill=function(){this.fill.fill="none"},this.drawRect=function(t){d.drawing&&console.log(d.drawing),t[2]<0&&(t[0]+=t[2],t[2]=-t[2]),t[3]<0&&(t[1]+=t[3],t[3]=-t[3]);var e=n("rect",{x:t[0],y:t[1],width:t[2],height:t[3]});c(e,this),l(e,this),o.appendChild(e)},this.drawRoundRect=function(t){var e=n("rect",{x:t[0],y:t[1],width:t[2],height:t[3],rx:t[4],ry:t[5]});c(e,this),l(e,this),this.DOM.appendChild(e)},this.drawCircle=function(t){var e=n("circle",{cx:t[0],cy:t[1],r:t[2]});c(e,this),l(e,this),o.appendChild(e)},this.drawEllipse=function(t){var e=n("ellipse",{cx:t[0],cy:t[1],rx:t[2],ry:t[3]});c(e,this),l(e,this),o.appendChild(e)},this.drawTriangles=function(t){if(t[1].length%3!==0)throw new Error("Illegal drawTriangles index argument. Indices array size must be a multiple of 3.");for(var e=[],i=[],n=0;n<t[1].length/3;n++){var s=t[1][3*n],o=t[1][3*n+1],r=t[1][3*n+2],a=t[0][2*s],h=t[0][2*s+1],l=t[0][2*o],c=t[0][2*o+1],d=t[0][2*r],p=t[0][2*r+1];e.push(1,2,2,2),i.push(a,h,l,c,d,p,a,h)}this.drawPath([e,i,"evenOdd"])},this._clear=function(){if(!(d.scheduleClear.length<1)){for(d.scheduleTimer>-1&&(clearTimeout(d.scheduleTimer),d.scheduleTimer=-1);o.lastChild&&d.scheduleClear.length>0;)o.removeChild(d.scheduleClear.pop());d.scheduleClear=[]}},this.clear=function(){for(var t=o.children?o.children:o.childNodes,e=0;e<t.length;e++)d.scheduleClear.push(t[e]);var i=this;d.scheduleTimer=setTimeout(function(){i._clear(),d.scheduleTimer=-1},60)},this.__defineGetter__("filters",function(){return[]}),this.__defineSetter__("filters",function(t){this.setFilters([t])}),this.setFilters=function(t){var e=t[0];this.DOM.removeChild(s),s=n("defs");for(var i=0;i<e.length;i++){var o=e[i],h=n("filter",{id:"fe"+o.type+i,x:"-100%",y:"-100%",width:"400%",height:"400%"});switch(o.type){default:break;case"blur":h.appendChild(n("feGaussianBlur",{in:"SourceGraphic",stdDeviation:o.params.blurX+" "+o.params.blurY}));break;case"glow":var l=Math.floor(o.params.color/65536),c=Math.floor(o.params.color%65536/256),d=o.params.color%256,p=[0,0,0,l/256,0,0,0,0,c/256,0,0,0,0,d/256,0,0,0,0,1,0];h.appendChild(n("feColorMatrix",{type:"matrix",values:p.join(" ")})),h.appendChild(n("feGaussianBlur",{stdDeviation:o.params.blurX+" "+o.params.blurY,result:"coloredBlur"}));var f=n("feMerge");f.appendChild(n("feMergeNode",{in:"coloredBlur"})),f.appendChild(n("feMergeNode",{in:"SourceGraphic"})),h.appendChild(f)}s.appendChild(h)}this.DOM.appendChild(s),this.DOM.removeChild(a);for(var u=r,i=0;i<e.length;i++){var m=n("g",{filter:"url(#fe"+e[i].type+i+")"});m.appendChild(u),u=m}this.DOM.appendChild(u),a=u},this.unload=function(){try{e.removeChild(this.DOM)}catch(t){}},e.appendChild(this.DOM)},e.prototype.Unpack.Sprite=function(e,i,n){this.DOM=t("div",{style:{position:"absolute",top:i.y?i.y+"px":"0px",left:i.x?i.x+"px":"0px",width:"100%",height:"100%",overflow:"visible",transformOrigin:"0 0 0"}}),i.scaleX=1,i.scaleY=1,i.children=[],this.__defineSetter__("visible",function(t){this.DOM.style.visibility=t?"visible":"hidden"}),this.__defineGetter__("visible",function(){return"hidden"===this.DOM.style.visibility?!1:!0}),this.__defineSetter__("alpha",function(t){this.DOM.style.opacity=t}),this.__defineGetter__("alpha",function(){return this.DOM.style.opacity}),this.__defineSetter__("x",function(t){this.setX(t)}),this.__defineSetter__("y",function(t){this.setY(t)}),this.__defineGetter__("x",function(){return this.DOM.offsetLeft}),this.__defineGetter__("y",function(){return this.DOM.offsetTop}),this.__defineGetter__("transform",function(){return{}}),this.__defineSetter__("transform",function(t){if("2d"===t.mode)var e=[t.matrix[0],t.matrix[3],t.matrix[1],t.matrix[4],t.matrix[2],t.matrix[5]],i="matrix("+e.join(",")+")";else var i="matrix3d("+t.matrix.join(",")+")";this.DOM.style.transform=i}),this.setX=function(t){this.DOM.style.left=t+"px"},this.setY=function(t){this.DOM.style.top=t+"px"},this.setWidth=function(t){this.DOM.style.width=t+"px"},this.setHeight=function(t){this.DOM.style.height=t+"px"},this.addChild=function(t){var s=n.getObject(t);if(i.children.push(s),s)if(s.DOM){if("Shape"===s.getClass()){var o=this.x+e.offsetWidth/2,r=this.y+e.offsetHeight/2;s.offset(o,r),s.DOM.style.left=-o+"px",s.DOM.style.top=-r+"px"}this.DOM.appendChild(s.DOM)}else n.invokeError("Sprite.addChild failed. Attempted to add non object","err")},this.removeChild=function(t){var e=n.getObject(t);if(e)try{this.DOM.removeChild(e.DOM)}catch(t){n.invokeError(t.stack,"err")}},this.unload=function(){try{e.removeChild(this.DOM)}catch(t){}},e.appendChild(this.DOM)},e.prototype.Unpack.SpriteRoot=function(t,e,i){this.DOM=t,this.addChild=function(t){var e=i.getObject(t);e&&(e.DOM?("Shape"===e.getClass()&&(e.DOM.style.left=-this.x+"px",e.DOM.style.top=-this.y+"px",e.setX(this.x),e.setY(this.y)),this.DOM.appendChild(e.DOM)):i.invokeError("Sprite.addChild failed. Attempted to add non object","err"))},this.removeChild=function(t){var e=i.getObject(t);if(e)try{this.DOM.removeChild(e.DOM)}catch(t){i.invokeError(t.stack,"err")}}},e.prototype.Unpack.Button=function(e,i,n){this.DOM=t("div",{className:"button",style:{position:"absolute",top:i.y?i.y+"px":"0px",left:i.x?i.x+"px":"0px"}},[t("text",i.text)]),i.scaleX=1,i.scaleY=1,this.__defineSetter__("visible",function(t){this.DOM.style.visibility=t?"visible":"hidden"}),this.__defineGetter__("visible",function(){return"hidden"===this.DOM.style.visibility?!1:!0}),this.__defineGetter__("transform",function(){return{}}),this.__defineSetter__("transform",function(){}),this.__defineSetter__("filters",function(){}),this.__defineGetter__("filters",function(){return[]}),this.__defineSetter__("alpha",function(t){i.alpha=Math.min(Math.max(t,0),1),this.DOM.style.opacity=i.alpha+""}),this.__defineGetter__("alpha",function(){return void 0!==i.alpha?i.alpha:1}),this.__defineSetter__("scaleX",function(t){if(!(t>50)){i.scaleX=t;for(var e=0;e<this.DOM.children.length;e++)this.DOM.children[e].style.transform="scale("+i.scaleX+","+i.scaleY+")"}}),this.__defineSetter__("scaleY",function(t){if(!(t>50)){i.scaleY=t;for(var e=0;e<this.DOM.children.length;e++)this.DOM.children[e].style.transform="scale("+i.scaleX+","+i.scaleY+")"}}),this.__defineGetter__("scaleX",function(){return i.scaleX}),this.__defineGetter__("scaleY",function(){return i.scaleY}),this.__defineSetter__("x",function(t){this.setX(t)}),this.__defineSetter__("y",function(t){this.setY(t)}),this.__defineGetter__("x",function(){return this.DOM.offsetLeft}),this.__defineGetter__("y",function(){return this.DOM.offsetTop}),this.setX=function(t){this.DOM.style.left=t+"px"},this.setY=function(t){this.DOM.style.top=t+"px"},this.setWidth=function(t){this.DOM.style.width=t+"px"},this.setHeight=function(t){this.DOM.style.height=t+"px"},this.addChild=function(t){var e=n.getObject(t);e&&(e.DOM?("Shape"===e.getClass()&&(e.DOM.style.left=-this.x+"px",e.DOM.style.top=-this.y+"px",e.setX(this.x),e.setY(this.y)),this.DOM.appendChild(e.DOM)):n.invokeError("Sprite.addChild failed. Attempted to add non object","err"))},this.removeChild=function(t){var e=n.getObject(t);if(e)try{this.DOM.removeChild(e.DOM)}catch(t){n.invokeError(t.stack,"err")}},this.unload=function(){try{e.removeChild(this.DOM)}catch(t){}},e.appendChild(this.DOM)};for(var i in e.prototype.Unpack)e.prototype.Unpack[i].prototype.getClass=function(){var t=i;return function(){return t}}()}();/**
 * Binary Search Stubs for JS Arrays
 * @license MIT
 * @author Jim Chen
 */
var BinArray=function(){var t={};return t.bsearch=function(t,e,i){if(0===t.length)return 0;if(i(e,t[0])<0)return 0;if(i(e,t[t.length-1])>=0)return t.length;for(var n=0,s=0,o=0,r=t.length-1;r>=n;){if(s=Math.floor((r+n+1)/2),o++,i(e,t[s-1])>=0&&i(e,t[s])<0)return s;i(e,t[s-1])<0?r=s-1:i(e,t[s])>=0?n=s:console.error("Program Error"),o>1500&&console.error("Too many run cycles.")}return-1},t.binsert=function(e,i,n){var s=t.bsearch(e,i,n);return e.splice(s,0,i),s},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},CommentSpaceAllocator=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this._pools=[[]],this.avoid=1,this._width=t,this._height=e}return t.prototype.willCollide=function(t,e){return t.stime+t.ttl>=e.stime+e.ttl/2},t.prototype.pathCheck=function(t,e,i){for(var n=t+e.height,s=e.right,o=0;o<i.length;o++)if(!(i[o].y>n||i[o].bottom<t)){if(!(i[o].right<e.x||i[o].x>s))return!1;if(this.willCollide(i[o],e))return!1}return!0},t.prototype.assign=function(t,e){for(;this._pools.length<=e;)this._pools.push([]);var i=this._pools[e];if(0===i.length)return t.cindex=e,0;if(this.pathCheck(0,t,i))return t.cindex=e,0;for(var n=0,s=0;s<i.length&&(n=i[s].bottom+this.avoid,!(n+t.height>this._height));s++)if(this.pathCheck(n,t,i))return t.cindex=e,n;return this.assign(t,e+1)},t.prototype.add=function(t){t.height>this._height?(t.cindex=-2,t.y=0):(t.y=this.assign(t,0),BinArray.binsert(this._pools[t.cindex],t,function(t,e){return t.bottom<e.bottom?-1:t.bottom>e.bottom?1:0}))},t.prototype.remove=function(t){if(!(t.cindex<0)){if(t.cindex>=this._pools.length)throw console.log(t.cindex,t),new Error("cindex out of bounds");var e=this._pools[t.cindex].indexOf(t);0>e||this._pools[t.cindex].splice(e,1)}},t.prototype.setBounds=function(t,e){this._width=t,this._height=e},t}(),AnchorCommentSpaceAllocator=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.add=function(e){t.prototype.add.call(this,e),e.x=(this._width-e.width)/2},e.prototype.willCollide=function(){return!0},e.prototype.pathCheck=function(t,e,i){for(var n=t+e.height,s=0;s<i.length;s++)if(!(i[s].y>n||i[s].bottom<t))return!1;return!0},e}(CommentSpaceAllocator),CoreComment=function(){function t(e,i){if(void 0===i&&(i={}),this.mode=1,this.stime=0,this.text="",this.ttl=4e3,this.dur=4e3,this.cindex=-1,this.motion=[],this.movable=!0,this._alphaMotion=null,this.absolute=!0,this.align=0,this._alpha=1,this._size=25,this._color=16777215,this._border=!1,this._shadow=!0,this._font="",!e)throw new Error("Comment not bound to comment manager.");if(this.parent=e,i.hasOwnProperty("stime")&&(this.stime=i.stime),this.mode=i.hasOwnProperty("mode")?i.mode:1,i.hasOwnProperty("dur")&&(this.dur=i.dur,this.ttl=this.dur),this.dur*=this.parent.options.global.scale,this.ttl*=this.parent.options.global.scale,(4===this.mode||5===this.mode)&&(this.dur*=.6,this.ttl*=.6),i.hasOwnProperty("text")&&(this.text=i.text),i.hasOwnProperty("motion")){this._motionStart=[],this._motionEnd=[],this.motion=i.motion;for(var n=0,s=0;s<i.motion.length;s++){this._motionStart.push(n);var o=0;for(var r in i.motion[s]){var a=i.motion[s][r];o=Math.max(a.dur,o),(null===a.easing||void 0===a.easing)&&(i.motion[s][r].easing=t.LINEAR)}n+=o,this._motionEnd.push(n)}this._curMotion=0}i.hasOwnProperty("color")&&(this._color=i.color),i.hasOwnProperty("size")&&(this._size=i.size),i.hasOwnProperty("border")&&(this._border=i.border),i.hasOwnProperty("opacity")&&(this._alpha=i.opacity),i.hasOwnProperty("alpha")&&(this._alphaMotion=i.alpha),i.hasOwnProperty("font")&&(this._font=i.font),i.hasOwnProperty("x")&&(this._x=i.x),i.hasOwnProperty("y")&&(this._y=i.y),i.hasOwnProperty("shadow")&&(this._shadow=i.shadow),i.hasOwnProperty("position")&&"relative"===i.position&&(this.absolute=!1,this.mode<7&&console.warn("Using relative position for CSA comment."))}return t.prototype.init=function(t){void 0===t&&(t=null),this.dom=null!==t?t.dom:document.createElement("div"),this.dom.className=this.parent.options.global.className,this.dom.appendChild(document.createTextNode(this.text)),this.dom.textContent=this.text,this.dom.innerText=this.text,this.size=this._size,16777215!=this._color&&(this.color=this._color),this.shadow=this._shadow,this._border&&(this.border=this._border),""!==this._font&&(this.font=this._font),void 0!==this._x&&(this.x=this._x),void 0!==this._y&&(this.y=this._y),(1!==this._alpha||this.parent.options.global.opacity<1)&&(this.alpha=this._alpha),this.motion.length>0&&this.animate()},Object.defineProperty(t.prototype,"x",{get:function(){return(null===this._x||void 0===this._x)&&(this._x=this.align%2===0?this.dom.offsetLeft:this.parent.width-this.dom.offsetLeft-this.width),this.absolute?this._x:this._x/this.parent.width},set:function(t){this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return(null===this._y||void 0===this._y)&&(this._y=this.align<2?this.dom.offsetTop:this.parent.height-this.dom.offsetTop-this.height),this.absolute?this._y:this._y/this.parent.height},set:function(t){this._y=t,this.absolute||(this._y*=this.parent.height),this.align<2?this.dom.style.top=this._y+"px":this.dom.style.bottom=this._y+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return(null===this._width||void 0===this._width)&&(this._width=this.dom.offsetWidth),this._width},set:function(t){this._width=t,this.dom.style.width=this._width+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return(null===this._height||void 0===this._height)&&(this._height=this.dom.offsetHeight),this._height},set:function(t){this._height=t,this.dom.style.height=this._height+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t,this.dom.style.fontSize=this._size+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t;var e=t.toString(16);e=e.length>=6?e:new Array(6-e.length+1).join("0")+e,this.dom.style.color="#"+e,0===this._color&&(this.dom.className=this.parent.options.global.className+" rshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(this._alpha,this.parent.options.global.opacity)+""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"border",{get:function(){return this._border},set:function(t){this._border=t,this.dom.style.border=this._border?"1px solid #00ffff":"none"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._shadow},set:function(t){this._shadow=t,this._shadow||(this.dom.className=this.parent.options.global.className+" noshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"font",{get:function(){return this._font},set:function(t){this._font=t,this.dom.style.fontFamily=this._font.length>0?this._font:""},enumerable:!0,configurable:!0}),t.prototype.time=function(t){this.ttl-=t,this.ttl<0&&(this.ttl=0),this.movable&&this.update(),this.ttl<=0&&this.finish()},t.prototype.update=function(){this.animate()},t.prototype.invalidate=function(){this._x=null,this._y=null,this._width=null,this._height=null},t.prototype._execMotion=function(t,e){for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];this[i]=n.easing(Math.min(Math.max(e-n.delay,0),n.dur),n.from,n.to-n.from,n.dur)}},t.prototype.animate=function(){if(this._alphaMotion&&(this.alpha=(this.dur-this.ttl)*(this._alphaMotion.to-this._alphaMotion.from)/this.dur+this._alphaMotion.from),0!==this.motion.length){var t=Math.max(this.ttl,0),e=this.dur-t-this._motionStart[this._curMotion];return this._execMotion(this.motion[this._curMotion],e),this.dur-t>this._motionEnd[this._curMotion]?(this._curMotion++,void(this._curMotion>=this.motion.length&&(this._curMotion=this.motion.length-1))):void 0}},t.prototype.stop=function(){},t.prototype.finish=function(){this.parent.finish(this)},t.prototype.toString=function(){return["[",this.stime,"|",this.ttl,"/",this.dur,"]","(",this.mode,")",this.text].join("")},t.LINEAR=function(t,e,i,n){return t*i/n+e},t}(),ScrollComment=function(t){function e(e,i){t.call(this,e,i),this.dur*=this.parent.options.scroll.scale,this.ttl*=this.parent.options.scroll.scale}return __extends(e,t),Object.defineProperty(e.prototype,"alpha",{set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(Math.min(this._alpha,this.parent.options.global.opacity),this.parent.options.scroll.opacity)+""},enumerable:!0,configurable:!0}),e.prototype.init=function(e){void 0===e&&(e=null),t.prototype.init.call(this,e),this.x=this.parent.width,this.parent.options.scroll.opacity<1&&(this.alpha=this._alpha),this.absolute=!0},e.prototype.update=function(){this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width},e}(CoreComment),CSSCompatLayer=function(){function t(){}return t.transform=function(t,e){t.style.transform=e,t.style.webkitTransform=e,t.style.msTransform=e,t.style.oTransform=e},t}(),CSSScrollComment=function(t){function e(){t.apply(this,arguments),this._dirtyCSS=!0}return __extends(e,t),Object.defineProperty(e.prototype,"x",{get:function(){return this.ttl/this.dur*(this.parent.width+this.width)-this.width},set:function(t){if("number"==typeof this._x){var e=t-this._x;this._x=t,CSSCompatLayer.transform(this.dom,"translateX("+e+"px)")}else this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),e.prototype.update=function(){this._dirtyCSS&&(this.dom.style.transition="transform "+this.ttl+"ms linear",this.x=-this.width,this._dirtyCSS=!1)},e.prototype.invalidate=function(){t.prototype.invalidate.call(this),this._dirtyCSS=!0},e.prototype.stop=function(){this.dom.style.transition="",this.x=this._x,this._x=null,this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width,this._dirtyCSS=!0},e}(ScrollComment),CommentManager=function(){function t(t){var e=0,n=this;this._listeners={},this._lastPosition=0,this.stage=t,this.paused=!0,this.pausedTime=0,this.canvas=document.createElement("canvas"),this.canvasOffscreen=document.createElement("canvas"),this.canvasFPS=0,n.canvas.style.width="100%",n.canvas.style.height="100%",n.canvas.style.transition="opacity .2s",n.stage.appendChild(n.canvas),this.options={global:{opacity:1,scale:1,className:"cmt",useCSS:!1,autoOpacity:!1},scroll:{opacity:1,scale:1},limit:0},this.timeline=[],this.runline=[],this.position=0,this.limiter=0,this.filter=null,this.csa={scroll:new CommentSpaceAllocator(0,0),top:new AnchorCommentSpaceAllocator(0,0),bottom:new AnchorCommentSpaceAllocator(0,0),reverse:new CommentSpaceAllocator(0,0),scrollbtm:new CommentSpaceAllocator(0,0)},this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight;var s=0;this.startTimer=function(){if(!(e>0)){var t=(new Date).getTime(),i=this;e=window.setInterval(function(){var e=(new Date).getTime()-t;t=(new Date).getTime(),i.onTimerEvent(e,i),i.sendQueueLoader()},1e3/60),this.paused=!1,this.pausedTime=Date.now()-s}},this.stopTimer=function(){window.clearInterval(e),e=0,this.paused=!0,s=Date.now()};var o=this.options.global.opacity,r=!1,l=0,c=0,d=function(){n.options.global.autoOpacity&&(n.canvas.style.opacity=n.options.global.opacity*i(c),n.options.scroll.opacity=i(c))};setInterval(function(){n.canvasFPS=l,l=0},1e3),this.addEventListener("enterComment",function(){c++,d()}),this.addEventListener("exitComment",function(){c--,d()}),this.canvasDrawerWrapper=function(){r||(r=!0,l++,o!=n.options.global.opacity&&(o=n.options.global.opacity,n.canvas.style.opacity=o),n.canvasDrawer(),r=!1)},this.ttlRecalcAll=function(){this.runline.forEach(a)};var p=[];this.send=function(t){p.push(t)},this.sendQueueLoader=function(){for(var t,e=performance.now();p.length>0;)if(n.sendAsync(p.shift()),t=performance.now()-e,t>8)return},this.addEventListener("clear",function(){p=[]}),requestAnimationFrame(this.canvasDrawerWrapper),function(){var t=window.devicePixelRatio;window.addEventListener("resize",function(){var e=window.devicePixelRatio;t!=e&&(n.runline.forEach(function(t){t.textData&&h(t)}),t=e),n.ttlRecalcAll()})}()}var e=function(t,e){for(var i=Math.PI/180,n=t*i,s=e*i,o=Math.cos,r=Math.sin,a=[o(n)*o(s),o(n)*r(s),r(n),0,-r(s),o(s),0,0,-r(n)*o(s),-r(n)*r(s),o(n),0,0,0,0,1],h=0;h<a.length;h++)Math.abs(a[h])<1e-6&&(a[h]=0);return"matrix3d("+a.join(",")+")"},i=function(t){return-Math.tanh((t-50)/25)/Math.PI*.8+.718},n="-apple-system,Arial,'PingFang SC','STHeiti Light','Hiragino Kaku Gothic ProN','Microsoft YaHei'";t.prototype.stop=function(){this.stopTimer();for(var t=0;t<this.runline.length;t++)"undefined"!=typeof this.runline[t].stop&&this.runline[t].stop()},t.prototype.start=function(){this.startTimer()},t.prototype.seek=function(t){this.position=BinArray.bsearch(this.timeline,t,function(t,e){return t<e.stime?-1:t>e.stime?1:0})},t.prototype.validate=function(t){return null==t?!1:this.filter.doValidate(t)},t.prototype.load=function(t){this.timeline=t,this.timeline.sort(function(t,e){return t.stime>e.stime?2:t.stime<e.stime?-2:t.date>e.date?1:t.date<e.date?-1:null!=t.dbid&&null!=e.dbid?t.dbid>e.dbid?1:t.dbid<e.dbid?-1:0:0}),this.dispatchEvent("load")},t.prototype.insert=function(t){var e=BinArray.binsert(this.timeline,t,function(t,e){return t.stime>e.stime?2:t.stime<e.stime?-2:t.date>e.date?1:t.date<e.date?-1:null!=t.dbid&&null!=e.dbid?t.dbid>e.dbid?1:t.dbid<e.dbid?-1:0:0});e<=this.position&&this.position++,this.dispatchEvent("insert")},t.prototype.clear=function(){for(;this.runline.length>0;)this.runline[0].finish();this.dispatchEvent("clear"),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this.dispatchEvent("resize");for(var t in this.csa)this.csa[t].setBounds(this.width,this.height);this.stage.style.perspective=this.width*Math.tan(40*Math.PI/180)/2+"px",this.stage.style.webkitPerspective=this.width*Math.tan(40*Math.PI/180)/2+"px"},t.prototype.init=function(){this.setBounds(),null==this.filter&&(this.filter=new CommentFilter)},t.prototype.time=function(t){if(t-=1,this.position>=this.timeline.length||Math.abs(this._lastPosition-t)>=2e3){if(this.seek(t),this._lastPosition=t,this.timeline.length<=this.position)return}else this._lastPosition=t;for(;this.position<this.timeline.length&&this.timeline[this.position].stime<=t;this.position++)this.options.limit>0&&this.runline.length>this.limiter||this.validate(this.timeline[this.position])&&this.send(this.timeline[this.position])},t.prototype.canvasResize=function(){var t=(this.width,this.height,window.devicePixelRatio),e=this.canvas,i=e.getContext("2d").getImageData(0,0,e.width,e.height);e.width=e.offsetWidth*t,e.height=e.offsetHeight*t,this.canvasOffscreen.width=e.width,this.canvasOffscreen.height=e.height,e.getContext("2d").putImageData(i,0,0),this.ttlRecalcAll()},t.prototype.canvasDrawer=function(){if(!this.options.global.useCSS){if(this.paused)return void requestAnimationFrame(this.canvasDrawerWrapper);var t,e,i=Date.now(),n=window.devicePixelRatio,s=this.pausedTime,r=this.canvasOffscreen.getContext("2d"),a=this.width,h=this.height;r.clearRect(0,0,a*n,h*n),r.imageSmoothingEnabled=!1,0!=s&&(this.runline.forEach(function(t){if(t.textData)switch(t.mode){case 1:t.prev+=s;break;case 4:case 5:t.removeTime+=s}}),this.pausedTime=0),this.runline.forEach(function(s){if(s.textData){switch(s.mode){case 1:s.rx+=s.speed*(i-s.prev)/1e3,s.x=a-s.rx,t=a-s.rx,e=s.y,s.prev=i;break;case 4:s.x=(a-s.width)/2,t=s.x,e=h-s.y-s.height;break;case 5:s.x=(a-s.width)/2,t=s.x,e=s.y}r.drawImage(s.textData,o(t*n),o(e*n))}});var l=this.canvas.getContext("2d");l.clearRect(0,0,this.canvas.width,this.canvas.height),l.drawImage(this.canvasOffscreen,0,0),requestAnimationFrame(this.canvasDrawerWrapper)}};var s=Math.ceil,o=Math.round,r=function(t){for(var t=t.toString(16);t.length<6;)t="0"+t;return t},a=function(t){if(t.speed){var e=t.dur-t.ttl;t.dur=(t.parent.width+t.width)/t.speed*1e3,t.ttl=t.dur-e}},h=function(t){var e=document.createElement("canvas"),i=e.getContext("2d"),a=window.devicePixelRatio;i.font=t.size*a+"px "+n,i.imageSmoothingEnabled=!1,t.width=s(i.measureText(t.text).width/a)+2,t.height=s(t.size+3)+2,t.oriWidth=s(t.width*a),t.oriHeight=s(t.height*a),e.width=t.oriWidth,e.height=t.oriHeight,i.font=t.size*a+"px "+n,i.lineWidth=o(1*a),i.strokeStyle=0==t._color?"#FFFFFF":"#000000",i.textBaseline="bottom",i.textAlign="left",i.shadowBlur=o(2*a),i.shadowColor=0==t._color?"#FFFFFF":"#000000",i.fillStyle="#"+r(t.color),i.strokeText(t.text,1,e.height-1),i.fillText(t.text,1,e.height-1),t.border&&(i.lineWidth=o(2*a),i.strokeStyle="#00ffff",i.shadowBlur=0,i.strokeRect(0,0,e.width,e.height)),t.textData=e};return t.prototype.getCommentFromPoint=function(t,e){var i,n,s=[],o=this.height;return this.runline.forEach(function(r){i=t-r.x,n=4==r.mode?e-(o-r.y-r.height):e-r.y,i>=0&&i<=r.width&&n>=0&&n<=r.height&&s.push(r)}),s},t.prototype.useCSS=function(t){this.options.global.useCSS=t,this.clear(),t||requestAnimationFrame(this.canvasDrawerWrapper)},t.prototype.autoOpacity=function(t){this.options.global.autoOpacity=t,t||(this.canvas.style.opacity=this.options.global.opacity,this.options.scroll.opacity=1)},t.prototype.sendAsync=function(t){if(8===t.mode)return console.log(t),void(this.scripting&&console.log(this.scripting.eval(t.code)));if(null==this.filter||(t=this.filter.doModify(t),null!=t&&t!==!1)){if(this.options.global.useCSS||-1==[1,4,5].indexOf(t.mode)){if(1===t.mode||2===t.mode||6===t.mode)var i=new CSSScrollComment(this,t);else var i=new CoreComment(this,t);switch(i.mode){case 1:i.align=0;break;case 2:i.align=2;break;case 4:i.align=2;break;case 5:i.align=0;break;case 6:i.align=1}switch(i.init(),this.stage.appendChild(i.dom),i.dom.transitionStartTime=(new Date).getTime(),i.mode){default:case 1:this.csa.scroll.add(i);break;case 2:this.csa.scrollbtm.add(i);break;case 4:this.csa.bottom.add(i);break;case 5:this.csa.top.add(i);break;case 6:this.csa.reverse.add(i);break;case 17:case 7:(0!==t.rY||0!==t.rZ)&&(i.dom.style.transform=e(t.rY,t.rZ),i.dom.style.webkitTransform=e(t.rY,t.rZ),i.dom.style.OTransform=e(t.rY,t.rZ),i.dom.style.MozTransform=e(t.rY,t.rZ),i.dom.style.MSTransform=e(t.rY,t.rZ))}i.y=i.y}else{var n=Date.now(),i=new CoreComment(this,t);switch(i.dom={style:{}},h(i),1==t.mode||6==t.mode?(i.rx=0,i.x=this.width,i.prev=n,i.speed=(this.width+i.width)/i.dur*1e3):(4==t.mode||5==t.mode)&&(i.removeTime=n+i.dur),i.mode){default:case 1:this.csa.scroll.add(i);break;case 4:this.csa.bottom.add(i);break;case 5:this.csa.top.add(i)}}i.originalData=t,this.dispatchEvent("enterComment",i),this.runline.push(i)}},t.prototype.finish=function(t){this.dispatchEvent("exitComment",t);try{this.stage.removeChild(t.dom)}catch(t){}var e=this.runline.indexOf(t);switch(e>=0&&this.runline.splice(e,1),t.mode){default:case 1:this.csa.scroll.remove(t);break;case 2:this.csa.scrollbtm.remove(t);break;case 4:this.csa.bottom.remove(t);break;case 5:this.csa.top.remove(t);break;case 6:this.csa.reverse.remove(t);break;case 7:}t.textData&&(t.textData=null)},t.prototype.resumeComment=function(){Array.prototype.slice.call(this.stage.children).forEach(function(t){t.classList.contains("cmt")&&t.classList.contains("paused")&&(t.style.transitionDuration=t.finalDuration+"ms",t.style.transform=t.finalTransform,t.transitionStartTime=(new Date).getTime(),t.classList.remove("paused"))})},t.prototype.pauseComment=function(){Array.prototype.slice.call(this.stage.children).forEach(function(t){t.classList.contains("cmt")&&!t.classList.contains("paused")&&(t.finalTransform=t.style.transform,t.style.transform=window.getComputedStyle(t).getPropertyValue("transform"),t.finalDuration=parseFloat(t.style.transitionDuration)-(new Date).getTime()+t.transitionStartTime,t.style.transitionDuration="10ms",t.classList.add("paused"))})},t.prototype.addEventListener=function(t,e){"undefined"!=typeof this._listeners[t]?this._listeners[t].push(e):this._listeners[t]=[e]},t.prototype.dispatchEvent=function(t,e){if("undefined"!=typeof this._listeners[t])for(var i=0;i<this._listeners[t].length;i++)try{this._listeners[t][i](e)}catch(t){console.err(t.stack)}},t.prototype.onTimerEvent=function(t,e){for(var i=0;i<e.runline.length;i++){var n=e.runline[i];n.hold||n.time(t)}},t}();/*end*/