/*!
 *
 * Comment Core Library CommentManager
 * @license MIT
 * @author Jim Chen
 *
 * Copyright (c) 2014 Jim Chen
 *
 * XMLParsr
 * == Licensed Under the MIT License : /LICENSING
 * Copyright (c) 2012 Jim Chen ( CQZ, Jabbany )
 */
/**
 * Binary Search Stubs for JS Arrays
 * @license MIT
 * @author Jim Chen
 */
/** 
 * Comment Filters Module Simplified (only supports modifiers & types)
 * @license MIT
 * @author Jim Chen
 */
function CommentFilter(){this.modifiers=[],this.runtime=null,this.allowTypes={1:!0,4:!0,5:!0,6:!0,7:!0,8:!0,17:!0},this.doModify=function(t){for(var i=0;i<this.modifiers.length;i++)t=this.modifiers[i](t);return t},this.beforeSend=function(t){return t},this.doValidate=function(t){return this.allowTypes[t.mode]?!0:!1},this.addRule=function(){},this.addModifier=function(t){this.modifiers.push(t)},this.runtimeFilter=function(t){return null==this.runtime?t:this.runtime(t)},this.setRuntimeFilter=function(t){this.runtime=t}}var BinArray=function(){var t={};return t.bsearch=function(t,i,e){if(0===t.length)return 0;if(e(i,t[0])<0)return 0;if(e(i,t[t.length-1])>=0)return t.length;for(var o=0,s=0,n=0,r=t.length-1;r>=o;){if(s=Math.floor((r+o+1)/2),n++,e(i,t[s-1])>=0&&e(i,t[s])<0)return s;e(i,t[s-1])<0?r=s-1:e(i,t[s])>=0?o=s:console.error("Program Error"),n>1500&&console.error("Too many run cycles.")}return-1},t.binsert=function(i,e,o){var s=t.bsearch(i,e,o);return i.splice(s,0,e),s},t}(),__extends=this&&this.__extends||function(t,i){function e(){this.constructor=t}for(var o in i)i.hasOwnProperty(o)&&(t[o]=i[o]);t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)},CommentSpaceAllocator=function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this._pools=[[]],this.avoid=1,this._width=t,this._height=i}return t.prototype.willCollide=function(t,i){return t.stime+t.ttl>=i.stime+i.ttl/2},t.prototype.pathCheck=function(t,i,e){for(var o=t+i.height,s=i.right,n=0;n<e.length;n++)if(!(e[n].y>o||e[n].bottom<t)){if(!(e[n].right<i.x||e[n].x>s))return!1;if(this.willCollide(e[n],i))return!1}return!0},t.prototype.assign=function(t,i){for(;this._pools.length<=i;)this._pools.push([]);var e=this._pools[i];if(0===e.length)return t.cindex=i,0;if(this.pathCheck(0,t,e))return t.cindex=i,0;for(var o=0,s=0;s<e.length&&(o=e[s].bottom+this.avoid,!(o+t.height>this._height));s++)if(this.pathCheck(o,t,e))return t.cindex=i,o;return this.assign(t,i+1)},t.prototype.add=function(t){t.height>this._height?(t.cindex=-2,t.y=0):(t.y=this.assign(t,0),BinArray.binsert(this._pools[t.cindex],t,function(t,i){return t.bottom<i.bottom?-1:t.bottom>i.bottom?1:0}))},t.prototype.remove=function(t){if(!(t.cindex<0)){if(t.cindex>=this._pools.length)throw console.log(t.cindex,t),new Error("cindex out of bounds");var i=this._pools[t.cindex].indexOf(t);0>i||this._pools[t.cindex].splice(i,1)}},t.prototype.setBounds=function(t,i){this._width=t,this._height=i},t}(),AnchorCommentSpaceAllocator=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.prototype.add=function(i){t.prototype.add.call(this,i),i.x=(this._width-i.width)/2},i.prototype.willCollide=function(){return!0},i.prototype.pathCheck=function(t,i,e){for(var o=t+i.height,s=0;s<e.length;s++)if(!(e[s].y>o||e[s].bottom<t))return!1;return!0},i}(CommentSpaceAllocator),CoreComment=function(){function t(i,e){if(void 0===e&&(e={}),this.mode=1,this.stime=0,this.text="",this.ttl=4e3,this.dur=4e3,this.cindex=-1,this.motion=[],this.movable=!0,this._alphaMotion=null,this.absolute=!0,this.align=0,this._alpha=1,this._size=25,this._color=16777215,this._border=!1,this._shadow=!0,this._font="",!i)throw new Error("Comment not bound to comment manager.");if(this.parent=i,e.hasOwnProperty("stime")&&(this.stime=e.stime),this.mode=e.hasOwnProperty("mode")?e.mode:1,e.hasOwnProperty("dur")&&(this.dur=e.dur,this.ttl=this.dur),this.dur*=this.parent.options.global.scale,this.ttl*=this.parent.options.global.scale,(4===this.mode||5===this.mode)&&(this.dur*=.6,this.ttl*=.6),e.hasOwnProperty("text")&&(this.text=e.text),e.hasOwnProperty("motion")){this._motionStart=[],this._motionEnd=[],this.motion=e.motion;for(var o=0,s=0;s<e.motion.length;s++){this._motionStart.push(o);var n=0;for(var r in e.motion[s]){var h=e.motion[s][r];n=Math.max(h.dur,n),(null===h.easing||void 0===h.easing)&&(e.motion[s][r].easing=t.LINEAR)}o+=n,this._motionEnd.push(o)}this._curMotion=0}e.hasOwnProperty("color")&&(this._color=e.color),e.hasOwnProperty("size")&&(this._size=e.size),e.hasOwnProperty("border")&&(this._border=e.border),e.hasOwnProperty("opacity")&&(this._alpha=e.opacity),e.hasOwnProperty("alpha")&&(this._alphaMotion=e.alpha),e.hasOwnProperty("font")&&(this._font=e.font),e.hasOwnProperty("x")&&(this._x=e.x),e.hasOwnProperty("y")&&(this._y=e.y),e.hasOwnProperty("shadow")&&(this._shadow=e.shadow),e.hasOwnProperty("position")&&"relative"===e.position&&(this.absolute=!1,this.mode<7&&console.warn("Using relative position for CSA comment."))}return t.prototype.init=function(t){void 0===t&&(t=null),this.dom=null!==t?t.dom:document.createElement("div"),this.dom.className=this.parent.options.global.className,this.dom.appendChild(document.createTextNode(this.text)),this.dom.textContent=this.text,this.dom.innerText=this.text,this.size=this._size,16777215!=this._color&&(this.color=this._color),this.shadow=this._shadow,this._border&&(this.border=this._border),""!==this._font&&(this.font=this._font),void 0!==this._x&&(this.x=this._x),void 0!==this._y&&(this.y=this._y),(1!==this._alpha||this.parent.options.global.opacity<1)&&(this.alpha=this._alpha),this.motion.length>0&&this.animate()},Object.defineProperty(t.prototype,"x",{get:function(){return(null===this._x||void 0===this._x)&&(this._x=this.align%2===0?this.dom.offsetLeft:this.parent.width-this.dom.offsetLeft-this.width),this.absolute?this._x:this._x/this.parent.width},set:function(t){this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return(null===this._y||void 0===this._y)&&(this._y=this.align<2?this.dom.offsetTop:this.parent.height-this.dom.offsetTop-this.height),this.absolute?this._y:this._y/this.parent.height},set:function(t){this._y=t,this.absolute||(this._y*=this.parent.height),this.align<2?this.dom.style.top=this._y+"px":this.dom.style.bottom=this._y+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return(null===this._width||void 0===this._width)&&(this._width=this.dom.offsetWidth),this._width},set:function(t){this._width=t,this.dom.style.width=this._width+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return(null===this._height||void 0===this._height)&&(this._height=this.dom.offsetHeight),this._height},set:function(t){this._height=t,this.dom.style.height=this._height+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t,this.dom.style.fontSize=this._size+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t;var i=t.toString(16);i=i.length>=6?i:new Array(6-i.length+1).join("0")+i,this.dom.style.color="#"+i,0===this._color&&(this.dom.className=this.parent.options.global.className+" rshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(this._alpha,this.parent.options.global.opacity)+""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"border",{get:function(){return this._border},set:function(t){this._border=t,this.dom.style.border=this._border?"1px solid #00ffff":"none"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._shadow},set:function(t){this._shadow=t,this._shadow||(this.dom.className=this.parent.options.global.className+" noshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"font",{get:function(){return this._font},set:function(t){this._font=t,this.dom.style.fontFamily=this._font.length>0?this._font:""},enumerable:!0,configurable:!0}),t.prototype.time=function(t){this.ttl-=t,this.ttl<0&&(this.ttl=0),this.movable&&this.update(),this.ttl<=0&&this.finish()},t.prototype.update=function(){this.animate()},t.prototype.invalidate=function(){this._x=null,this._y=null,this._width=null,this._height=null},t.prototype._execMotion=function(t,i){for(var e in t)if(t.hasOwnProperty(e)){var o=t[e];this[e]=o.easing(Math.min(Math.max(i-o.delay,0),o.dur),o.from,o.to-o.from,o.dur)}},t.prototype.animate=function(){if(this._alphaMotion&&(this.alpha=(this.dur-this.ttl)*(this._alphaMotion.to-this._alphaMotion.from)/this.dur+this._alphaMotion.from),0!==this.motion.length){var t=Math.max(this.ttl,0),i=this.dur-t-this._motionStart[this._curMotion];return this._execMotion(this.motion[this._curMotion],i),this.dur-t>this._motionEnd[this._curMotion]?(this._curMotion++,void(this._curMotion>=this.motion.length&&(this._curMotion=this.motion.length-1))):void 0}},t.prototype.stop=function(){},t.prototype.finish=function(){this.parent.finish(this)},t.prototype.toString=function(){return["[",this.stime,"|",this.ttl,"/",this.dur,"]","(",this.mode,")",this.text].join("")},t.LINEAR=function(t,i,e,o){return t*e/o+i},t}(),ScrollComment=function(t){function i(i,e){t.call(this,i,e),this.dur*=this.parent.options.scroll.scale,this.ttl*=this.parent.options.scroll.scale}return __extends(i,t),Object.defineProperty(i.prototype,"alpha",{set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(Math.min(this._alpha,this.parent.options.global.opacity),this.parent.options.scroll.opacity)+""},enumerable:!0,configurable:!0}),i.prototype.init=function(i){void 0===i&&(i=null),t.prototype.init.call(this,i),this.x=this.parent.width,this.parent.options.scroll.opacity<1&&(this.alpha=this._alpha),this.absolute=!0},i.prototype.update=function(){this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width},i}(CoreComment),CSSCompatLayer=function(){function t(){}return t.transform=function(t,i){t.style.transform=i,t.style.webkitTransform=i,t.style.msTransform=i,t.style.oTransform=i},t}(),CSSScrollComment=function(t){function i(){t.apply(this,arguments),this._dirtyCSS=!0}return __extends(i,t),Object.defineProperty(i.prototype,"x",{get:function(){return this.ttl/this.dur*(this.parent.width+this.width)-this.width},set:function(t){if("number"==typeof this._x){var i=t-this._x;this._x=t,CSSCompatLayer.transform(this.dom,"translateX("+i+"px)")}else this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),i.prototype.update=function(){this._dirtyCSS&&(this.dom.style.transition="transform "+this.ttl+"ms linear",this.x=-this.width,this._dirtyCSS=!1)},i.prototype.invalidate=function(){t.prototype.invalidate.call(this),this._dirtyCSS=!0},i.prototype.stop=function(){this.dom.style.transition="",this.x=this._x,this._x=null,this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width,this._dirtyCSS=!0},i}(ScrollComment),CommentManager=function(){function t(t){var i=0,o=this;this._listeners={},this._lastPosition=0,this.stage=t,this.paused=!0,this.pausedTime=0,this.options={global:{opacity:1,scale:1,className:"cmt",autoOpacity:!1},scroll:{opacity:1,scale:1},limit:0},this.timeline=[],this.runline=[],this.position=0,this.limiter=0,this.filter=null,this.csa={scroll:new CommentSpaceAllocator(0,0),top:new AnchorCommentSpaceAllocator(0,0),bottom:new AnchorCommentSpaceAllocator(0,0),reverse:new CommentSpaceAllocator(0,0),scrollbtm:new CommentSpaceAllocator(0,0)},this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight;var s=0;this.startTimer=function(){if(!(i>0)){var t=(new Date).getTime(),e=this;i=window.setInterval(function(){var i=(new Date).getTime()-t;t=(new Date).getTime(),e.onTimerEvent(i,e)},1e3/60),this.paused=!1,this.pausedTime=Date.now()-s}},this.stopTimer=function(){window.clearInterval(i),i=0,this.paused=!0,s=Date.now()};var n=(this.options.global.opacity,0),r=1,h=function(){o.options.global.autoOpacity&&(r=e(n))};setInterval(function(){o.options.global.autoOpacity&&(o.stage.style.opacity=r)},200),this.addEventListener("enterComment",function(){n++,h()}),this.addEventListener("exitComment",function(){n--,h()})}var i=function(t,i){for(var e=Math.PI/180,o=t*e,s=i*e,n=Math.cos,r=Math.sin,h=[n(o)*n(s),n(o)*r(s),r(o),0,-r(s),n(s),0,0,-r(o)*n(s),-r(o)*r(s),n(o),0,0,0,0,1],a=0;a<h.length;a++)Math.abs(h[a])<1e-6&&(h[a]=0);return"matrix3d("+h.join(",")+")"},e=function(t){return-Math.tanh((t-50)/25)/Math.PI*.8+.718};return t.prototype.stop=function(){this.stopTimer();for(var t=0;t<this.runline.length;t++)"undefined"!=typeof this.runline[t].stop&&this.runline[t].stop()},t.prototype.start=function(){this.startTimer()},t.prototype.seek=function(t){this.position=BinArray.bsearch(this.timeline,t,function(t,i){return t<i.stime?-1:t>i.stime?1:0})},t.prototype.validate=function(t){return null==t?!1:this.filter.doValidate(t)},t.prototype.load=function(t){this.timeline=t,this.timeline.sort(function(t,i){return t.stime>i.stime?2:t.stime<i.stime?-2:t.date>i.date?1:t.date<i.date?-1:null!=t.dbid&&null!=i.dbid?t.dbid>i.dbid?1:t.dbid<i.dbid?-1:0:0}),this.dispatchEvent("load")},t.prototype.insert=function(t){var i=BinArray.binsert(this.timeline,t,function(t,i){return t.stime>i.stime?2:t.stime<i.stime?-2:t.date>i.date?1:t.date<i.date?-1:null!=t.dbid&&null!=i.dbid?t.dbid>i.dbid?1:t.dbid<i.dbid?-1:0:0});i<=this.position&&this.position++,this.dispatchEvent("insert")},t.prototype.clear=function(){for(;this.runline.length>0;)this.runline[0].finish();this.dispatchEvent("clear")},t.prototype.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this.dispatchEvent("resize");for(var t in this.csa)this.csa[t].setBounds(this.width,this.height);this.stage.style.perspective=this.width*Math.tan(40*Math.PI/180)/2+"px",this.stage.style.webkitPerspective=this.width*Math.tan(40*Math.PI/180)/2+"px"},t.prototype.init=function(){this.setBounds(),null==this.filter&&(this.filter=new CommentFilter)},t.prototype.time=function(t){if(t-=1,this.position>=this.timeline.length||Math.abs(this._lastPosition-t)>=2e3){if(this.seek(t),this._lastPosition=t,this.timeline.length<=this.position)return}else this._lastPosition=t;for(;this.position<this.timeline.length&&this.timeline[this.position].stime<=t;this.position++)this.options.limit>0&&this.runline.length>this.limiter||this.validate(this.timeline[this.position])&&this.send(this.timeline[this.position])},t.prototype.getCommentFromPoint=function(t,i){var e,o,s=[],n=this.height;return this.runline.forEach(function(r){e=t-r.x,o=4==r.mode?i-(n-r.y-r.height):i-r.y,e>=0&&e<=r.width&&o>=0&&o<=r.height&&s.push(r)}),s},t.prototype.useCSS=function(){},t.prototype.autoOpacity=function(t){this.options.global.autoOpacity=t,t||(this.stage.style.opacity=1)},t.prototype.send=function(t){if(8===t.mode)return console.log(t),void(this.scripting&&console.log(this.scripting.eval(t.code)));if(null==this.filter||(t=this.filter.doModify(t),null!=t&&t!==!1)){if(1===t.mode||2===t.mode||6===t.mode)var e=new CSSScrollComment(this,t);else var e=new CoreComment(this,t);switch(e.mode){case 1:e.align=0;break;case 2:e.align=2;break;case 4:e.align=2;break;case 5:e.align=0;break;case 6:e.align=1}switch(e.init(),this.stage.appendChild(e.dom),e.dom.transitionStartTime=(new Date).getTime(),e.mode){default:case 1:this.csa.scroll.add(e);break;case 2:this.csa.scrollbtm.add(e);break;case 4:this.csa.bottom.add(e);break;case 5:this.csa.top.add(e);break;case 6:this.csa.reverse.add(e);break;case 17:case 7:(0!==t.rY||0!==t.rZ)&&(e.dom.style.transform=i(t.rY,t.rZ),e.dom.style.webkitTransform=i(t.rY,t.rZ),e.dom.style.OTransform=i(t.rY,t.rZ),e.dom.style.MozTransform=i(t.rY,t.rZ),e.dom.style.MSTransform=i(t.rY,t.rZ))}e.originalData=t,this.dispatchEvent("enterComment",e),this.runline.push(e)}},t.prototype.finish=function(t){this.dispatchEvent("exitComment",t);try{this.stage.removeChild(t.dom)}catch(t){}var i=this.runline.indexOf(t);switch(i>=0&&this.runline.splice(i,1),t.mode){default:case 1:this.csa.scroll.remove(t);break;case 2:this.csa.scrollbtm.remove(t);break;case 4:this.csa.bottom.remove(t);break;case 5:this.csa.top.remove(t);break;case 6:this.csa.reverse.remove(t);break;case 7:}t.textData&&(t.textData=null)},t.prototype.resumeComment=function(){Array.prototype.slice.call(this.stage.children).forEach(function(t){t.classList.contains("cmt")&&t.classList.contains("paused")&&(t.style.transitionDuration=t.finalDuration+"ms",t.style.transform=t.finalTransform,t.transitionStartTime=(new Date).getTime(),t.classList.remove("paused"))})},t.prototype.pauseComment=function(){Array.prototype.slice.call(this.stage.children).forEach(function(t){t.classList.contains("cmt")&&!t.classList.contains("paused")&&(t.finalTransform=t.style.transform,t.style.transform=window.getComputedStyle(t).getPropertyValue("transform"),t.finalDuration=parseFloat(t.style.transitionDuration)-(new Date).getTime()+t.transitionStartTime,t.style.transitionDuration="10ms",t.classList.add("paused"))})},t.prototype.addEventListener=function(t,i){"undefined"!=typeof this._listeners[t]?this._listeners[t].push(i):this._listeners[t]=[i]},t.prototype.dispatchEvent=function(t,i){if("undefined"!=typeof this._listeners[t])for(var e=0;e<this._listeners[t].length;e++)try{this._listeners[t][e](i)}catch(t){console.err(t.stack)}},t.prototype.onTimerEvent=function(t,i){for(var e=0;e<i.runline.length;e++){var o=i.runline[e];o.hold||o.time(t)}},t}();/*end*/